<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html><head><title>Torque Runtime Reference - Initialisation and Configuration - Torque</title><style type="text/css" media="all">
          @import url("../style/maven-base.css");
          
          @import url("../style/maven-theme.css");</style><link rel="stylesheet" href="../style/print.css" type="text/css" media="print"></link><meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"></meta><meta name="author" content="John McNally"></meta><meta name="email" content="jmcnally@apache.org"></meta><meta name="author" content="Martin Poeschl"></meta><meta name="email" content="mpoeschl@marmot.at"></meta><meta name="author" content="Scott Eade"></meta><meta name="email" content="seade@backstagetech.com.au"></meta><meta name="author" content="Thomas Fischer"></meta><meta name="email" content="fischer@seitenbau.de"></meta></head><body class="composite"><div id="banner"><a href="http://db.apache.org/" id="organizationLogo"><img alt="Apache Software Foundation" src="../images/db-logo-white.png"></img></a><a href="http://db.apache.org/torque/releases/torque-3.3/runtime/" id="projectLogo"><img alt="Torque" src="../images/torque-logo-new.png"></img></a><div class="clear"><hr></hr></div></div><div id="breadcrumbs"><div class="xleft">Last published: 28 February 2008
                <span class="separator">|</span> Doc for  3.3
                </div><div class="xright"></div><div class="clear"><hr></hr></div></div><div id="leftColumn"><div id="navcolumn"><div id="menuTorque"><h5>Torque</h5><ul><li class="none"><a href="../../../../index.html">Overview</a></li><li class="none"><a href="../../../../status.html">News and Status</a></li><li class="none"><a href="../../../../download.html">Downloads</a></li><li class="none"><a href="../../../../addons.html">Addons</a></li><li class="none"><a href="../../../../changes-report.html">Changes</a></li><li class="none"><a href="http://wiki.apache.org/db-torque/" class="externalLink" title="External Link">Wiki</a></li><li class="none"><a href="../../../../issue-tracking.html">Issue tracker</a></li><li class="none"><a href="../../../../mail-lists.html">Mailing lists</a></li><li class="none"><a href="../../../../tools/index.html">Tools</a></li><li class="collapsed"><a href="../../../../developer-info/index.html">Developer Information</a></li></ul></div><div id="menuModule_Documentation"><h5>Module Documentation</h5><ul><li class="none"><a href="../../../../documentation/index.html">Overview</a></li><li class="expanded"><a href="../../../../documentation/torque-3.3.html">Torque 3.3</a><ul><li class="collapsed"><a href="../../generator/index.html">Generator</a></li><li class="collapsed"><a href="../../maven-plugin/index.html">Maven 1 Plugin</a></li><li class="none"><a href="../../maven2-plugin/index.html" class="newWindow" title="New Window" target="_blank">Maven 2 Plugin</a></li><li class="expanded"><a href="../index.html">Runtime</a><ul><li class="expanded"><a href="../reference/index.html">Reference</a><ul><li class="none"><strong><a href="../reference/initialisation-configuration.html">Initialisation</a></strong></li><li class="none"><a href="../reference/read-from-db.html">Reading from the DB</a></li><li class="none"><a href="../reference/write-to-db.html">Writing to the DB</a></li><li class="none"><a href="../reference/extend-classes.html">Extending classes</a></li><li class="none"><a href="../reference/connections-transactions.html">Connections</a></li><li class="none"><a href="../reference/managers-cache.html">Managers and Cache</a></li><li class="none"><a href="../reference/beans.html">Beans</a></li><li class="none"><a href="../reference/relevant-classes.html">Relevant classes</a></li><li class="none"><a href="../reference/new-database-support.html">Supporting a new DB</a></li></ul></li><li class="none"><a href="../dependencies.html">Dependencies</a></li><li class="collapsed"><a href="../maven-reports.html">Project Reports</a></li></ul></li><li class="collapsed"><a href="../../tutorial/index.html">Tutorial</a></li><li class="collapsed"><a href="../../village/index.html">Village</a></li></ul></li><li class="collapsed"><a href="../../../../documentation/previous-releases.html">Previous releases</a></li></ul></div><div id="menuOther_Documentation"><h5>Other Documentation</h5><ul><li class="none"><a href="../../../../version-specific/supported-databases.html">Supported Databases</a></li><li class="collapsed"><a href="../../../../version-specific/database-howtos/index.html">Database Howtos</a></li><li class="collapsed"><a href="../../../../version-specific/other-howtos/index.html">Other Howtos</a></li></ul></div><div id="menuProject_Documentation"><h5>Project Documentation</h5><ul><li class="collapsed"><a href="../../../../project-info.html">Project info</a></li><li class="collapsed"><a href="../../../../project-reports.html">Site Project Reports</a></li></ul></div><div id="legend"><h5>Legend</h5><ul><li class="externalLink">External Link</li><li class="newWindow">Opens in a new window</li></ul></div><a href="http://maven.apache.org/" title="Built by Maven" id="poweredBy"><img alt="Built by Maven" src="../images/logos/maven-button-1.png"></img></a></div></div><div id="bodyColumn"><div class="contentBox"><div class="section"><a name="Initialisation"></a><h2>Initialisation</h2>
    <p>
      Torque is initialized by calling one of the <code>Torque.init()</code>
      methods. Torque must be initialized before it is used, and it must not
      be initialized more than once.
    </p>

    <p>
      When calling one of the <code>Torque.init()</code> methods, you
      must supply either the path to a configuration file or the configuration 
      itself.  The configuration must contain a valid <code>DataSource</code>,
      a default database handle, and an adapter for each 
      <code>DataSource</code>.
      For details, see the section <a href="#Configuration">Configuration</a>
      below.
    </p>
    
    <p>
      Upon initialisation, also the runtime model of the database,
      i.e. the <code>DatabaseMaps</code>, are built by autogenerated
      <code>MapBuilder</code>classes.  This happens automatically,
      so usually you need not bother about it.
    </p>
    
    <p>
      The detailed procedure is the following: Each peer class registers
      its Map builder with the Torque runtime when the Base Peer Class is loaded
      (Usually, a peer class is loaded if one of the constants
      for a column name is accessed, or a method is called).
      If Torque is already initialized when the Peer class is loaded
      (this is usually the case) the Map Builder builds the database map
      instantly and makes it avaliable to Torque. If Torque is not yet
      initialized, the Peer class stores the Map Builder with Torque,
      which builds the database Map when Torque is initialized.
    </p>
    
    <p>
      This means that you will not see a table in the database map if
      its peer class is not loaded.  If you want to make sure that all
      tables appear in the Database map, call the Database Map's
      initialize() method. This method triggers a generated class
      to insert all tables into the database map.
    </p>

  </div><div class="section"><a name="Configuration"></a><h2>Configuration</h2>
  
    <div class="subsection"><a name="Database_handles"></a><h3>Database handles</h3>

      <p>
        A database handle is the name attribute that was used in the
        <code>&lt;database&gt;</code> tag of the schema.xml file.  If the name
        attribute is not used, then the handle would be 'default'.
      </p>

      <p>
        In all examples that follow we will use the handle 'bookstore'.
        As Torque has the ability to use multiple databases you can tell it 
        which one to use by default thus:
      </p>


    <div class="source"><pre>
torque.database.default=bookstore
</pre></div>
  

      <p>
        The handle name 'default' is reserved, as Torque uses it as a reference
        to the default database.
        So you should not define the handle 'default' yourself (but of course
        you can use it e.g. in generated code).
      </p>

    </div>

    <div class="subsection"><a name="Database_Adapters"></a><h3>Database Adapters</h3>

      <p>
        Previously, Torque provided an internal map between many Drivers 
        and a set of adapter classes which are used to account for 
        differences among databases.
        This arrangement is no longer possible using <code>DataSource</code>, 
        so the adapter must be given in the configuration.
        The adapter property is given as:
      </p>


    <div class="source"><pre>
torque.database.bookstore.adapter=mysql
</pre></div>
  

      <p>
        The valid values are:
      </p>

      <table class="bodyTable">
        <tr class="a">
          <td>
            <ul>
              <li>as400</li>
              <li>axion</li>
              <li>db2app</li>
              <li>db2net</li>
              <li>cloudscape</li>
            </ul>
          </td>
          <td>
            <ul>
              <li>hypersonic</li>
              <li>interbase</li>
              <li>instantdb</li>
              <li>mssql</li>
              <li>mysql</li>
            </ul>
          </td>
          <td>
            <ul>
              <li>oracle</li>
              <li>postgresql</li>
              <li>sapdb</li>
              <li>sybase</li>
              <li>weblogic.</li>
            </ul>
          </td>
        </tr>
      </table>
      
      <p>
        If you want to use a custom adapter that is not supplied by Torque,
        you need to choose a custom key (not one of the above) and specify
        the class of the adapter. For example, if the adapter class is
        <code>com.acme.DBMyAdapter</code>, you could use the following
        snippet in your configuration file:
      </p>
 
      
    <div class="source"><pre>
torque.database.bookstore.adapter=myadapter
torque.database.bookstore.adapter.myadapter.className=com.acme.DBMyAdapter
      </pre></div>
  

    </div>

    <div class="subsection"><a name="Connection_pool"></a><h3>Connection pool</h3>
    
      <p>
        Torque can use any connection pool implementing the interface
        <code>DataSource</code>.  Torque expects a factory that can return a 
        <code>DataSource</code> and can be configured using Torque's
        configuration file.
      </p>

      <p>
        Torque provides factories to use the commons-dbcp pools as well as a 
        general factory that uses jndi to retrieve the <code>DataSource</code>.
        The jndi factory looks up a <code>DataSource</code> bound to jndi; it
        also provides a simple property file based way to configure and deploy most
        <code>DataSource</code>'s, though in many cases a pool may already be
        bound to jndi and torque only needs to use it.
      </p>

    </div>
    
  </div><div class="section"><a name="SharedPoolDataSourceFactory"></a><h2>SharedPoolDataSourceFactory</h2>

    <p>
      This factory uses the SharedDataSource available in the
      commons-dbcp package. SharedPoolDataSourceFactory provides an easy way
      to configure this pool and it assumes you will have a jdbc Driver class
      providing the physical database connections.  Again, you must let 
      Torque know you are using this factory:
    </p>


    <div class="source"><pre>
torque.dsfactory.bookstore.factory= \
  org.apache.torque.dsfactory.SharedPoolDataSourceFactory
</pre></div>
  

    <p>
      Then there are two sets of properties related to the pool 
      configuration and settings for making the connection to the database.
      The "connection" set contains all information to create a
      physical connection to the database:
    </p>


    <div class="source"><pre>
torque.dsfactory.bookstore.connection.driver = org.gjt.mm.mysql.Driver
torque.dsfactory.bookstore.connection.url = jdbc:mysql://localhost:3306/bookstore
torque.dsfactory.bookstore.connection.user = root
torque.dsfactory.bookstore.connection.password = 1234
</pre></div>
  

    <p>
      The "pool" set contains information of how the pool should
      handle the physical connections.  See
      <a href="http://commons.apache.org/dbcp/configuration.html" class="externalLink" title="External Link">the dbcp reference</a>
      for possible properties.  For example, you could use: 
    </p>


    <div class="source"><pre>
torque.dsfactory.bookstore.pool.maxActive=30
torque.dsfactory.bookstore.pool.testOnBorrow=true
torque.dsfactory.bookstore.pool.validationQuery=SELECT 1
</pre></div>
  


    <p>
      Torque also includes a factory for the 
      <code>PerUserPoolDataSource</code>.
      Please see the commons-dbcp javadoc for more info.
    </p>

  </div><div class="section"><a name="JndiDataSourceFactory"></a><h2>JndiDataSourceFactory</h2>

    <p>
      This factory is used if the <code>DataSource</code> is to be available 
      via jndi.  It is possible to use this factory to deploy a
      <code>DataSource</code> into jndi, but in many cases for using this 
      factory the <code>DataSource</code> is already deployed. 
      This factory is specified with the following property:
    </p>


    <div class="source"><pre>
torque.dsfactory.bookstore.factory = \
  org.apache.torque.dsfactory.JndiDataSourceFactory
</pre></div>
  


    <div class="subsection"><a name="Using_JndiDataSourceFactory_with_pre-configured_pool"></a><h3>Using JndiDataSourceFactory with pre-configured pool</h3>
    
      <p>
        In this section, it is assumed that a <code>DataSource</code>
        is available via jndi.  Usually, a J2EE environment can be configured
        to bind a <code>DataSource</code> into jndi for further use.
        For example, Tomcat can bind a <code>DataSource</code> into jndi, see
        <a href="http://tomcat.apache.org/tomcat-5.5-doc/jndi-datasource-examples-howto.html" class="externalLink" title="External Link">the Tomcat Documentation</a>
        for details.
      </p>

      <p>
        If a pool is known to already be available via jndi, 
        only one more property is required for Torque:
      </p>


    <div class="source"><pre>
torque.dsfactory.bookstore.jndi.path=jdbc/bookstore
</pre></div>
  

      <p>
        This line defines the string that will be used to lookup the
        <code>DataSource</code> within the default jndi 
        <code>InitialContext</code>.
        If everything is configured and the default <code>InitialContext</code>
        contains the <code>DataSource</code>, this is all that is
        needed.  The default <code>InitialContext</code> is chosen 
        according to the rules given in the class's javadoc.  
        If the default has not been configured, you can specify any other 
        environment properties that are needed to instantiate
        the <code>InitialContext</code> as extra properties of the form,
        torque.jndi.&lt;handle&gt;.&lt;env-var&gt;.
        A couple of examples are shown below:
      </p>


    <div class="source"><pre>
torque.dsfactory.bookstore.jndi.java.naming.factory.initial = \
  org.apache.naming.java.javaURLContextFactory
torque.dsfactory.bookstore.jndi.java.naming.factory.url.pkgs = \
  org.apache.naming
</pre></div>
  

      <p>
        Such environment settings will most likely not be necessary when running 
        within a J2EE container, but they are useful in other cases.
      </p>

      <p>
        One of the advantages of jndi is that it supports changing
        the <code>DataSource</code> on the fly.
        On the other hand this means that the actual <code>DataSource</code>
        object must be looked up in the context with every database operation.
        To avoid this, the factory provides a simple caching mechanism,
        which stores the <code>DataSource</code> object for a configurable
        amount of time (im ms). The <b>t</b>ime between <b>t</b>wo
        <b>l</b>ookups is specified as follows:
      </p>


    <div class="source"><pre>
torque.dsfactory.bookstore.jndi.ttl=60000
</pre></div>
  

      <p>
        This property is optional. If not specified, it defaults to 0 
        (no caching).
      </p>

    </div>

    <div class="subsection"><a name="Using_Torque_to_bind_a_pool_to_jndi"></a><h3>Using Torque to bind a pool to jndi</h3>

      <p>
        Generally a J2EE environment such as a servlet engine or application
        server is expected to provide a jdbc2 compatible connection pool.
        If your application is not running within such an environment,
        or even if it is and torque is your only use of a connection pool,
        Torque provides a simple properties file method of configuring a
        <code>DataSource</code> and deploying it via jndi.
      </p>
      
      <p>
        Too use this feature, you need to specify the jndi configuration 
        parameters as shown above, setting the factory and the jndi path.
        In addition to that, you need to configure
        the <code>DataSource</code> which should be bound into jndi.
        The one property that is necessary for all <code>DataSource</code>'s 
        is the classname of the <code>DataSource</code> implementation.
        Beyond that the properties are implementation specific, depending on the
        <code>DataSource</code>'s setters for the configuration.
        You can specify the values for the setters as properties in the
        configuration file.  For example, dbcp's <code>BasicDataSource</code>
        could be configured as shown below:
      </p>


    <div class="source"><pre>
torque.dsfactory.bookstore.datasource.classname= \
  org.apache.commons.dbcp.BasicDataSource
torque.dsfactory.bookstore.datasource.driver = org.gjt.mm.mysql.Driver
torque.dsfactory.bookstore.datasource.url = jdbc:mysql://localhost:3306/bookstore
torque.dsfactory.bookstore.datasource.user = root
torque.dsfactory.bookstore.datasource.password = 1234
</pre></div>
  

      <p>
        plus the properties for the factory and the jndi path:
      </p>
      

    <div class="source"><pre>
torque.dsfactory.bookstore.factory = \
  org.apache.torque.dsfactory.JndiDataSourceFactory
torque.dsfactory.bookstore.jndi.path=jdbc/bookstore
</pre></div>
  

      <p>
        Note that in dbcp 1.2.1, the SharedPoolDataSourceFactory and 
        PerUserPoolDataSourceFactory cannot be bound into jndi (this is a dbcp 
        problem).  
      </p>

    </div>
    
  </div><div class="section"><a name="Examples"></a><h2>Examples</h2>

    <p>
      In this section, the bits explained above are assembled to full
      examples of configuration files for the Torque runtime.  Do not forget
      to change the values to match your database environment.
    </p>
      
    <p>
      Using SharedPoolDataSourceFactory (this example is also used in the 
      Tutorial):
    </p>
      

    <div class="source"><pre>
torque.database.default = bookstore
torque.database.bookstore.adapter = mysql

#Using commons-dbcp
torque.dsfactory.bookstore.factory =\
  org.apache.torque.dsfactory.SharedPoolDataSourceFactory
torque.dsfactory.bookstore.connection.driver = org.gjt.mm.mysql.Driver
torque.dsfactory.bookstore.connection.url =\
  jdbc:mysql://localhost:3306/bookstore
torque.dsfactory.bookstore.connection.user = user
torque.dsfactory.bookstore.connection.password = password
</pre></div>
  

    <p>
      Using JndiDataSourceFactory with externally bound 
      <code>DataSource</code>:
    </p>
      

    <div class="source"><pre>
torque.database.default = bookstore
torque.database.bookstore.adapter = mysql
torque.dsfactory.bookstore.factory =\
  org.apache.torque.dsfactory.JndiDataSourceFactory
torque.dsfactory.bookstore.jndi.path = jdbc/jndiTestDataSource
</pre></div>
  

    <p>
      Using JndiDataSourceFactory to bind a <code>DataSource</code> to jndi:
    </p>
      

    <div class="source"><pre>
torque.database.default = bookstore
torque.database.bookstore.adapter = mysql
torque.dsfactory.bookstore.factory =\
  org.apache.torque.dsfactory.JndiDataSourceFactory
torque.dsfactory.bookstore.jndi.path = jdbc/jndiTestDataSource
torque.dsfactory.bookstore.jndi.java.naming.factory.initial =\
  org.apache.naming.java.javaURLContextFactory
torque.dsfactory.bookstore.datasource.classname =\
  org.apache.commons.dbcp.BasicDataSource
torque.dsfactory.bookstore.datasource.password = mysql
torque.dsfactory.bookstore.datasource.username = root
torque.dsfactory.bookstore.datasource.driverClassName =\
  org.gjt.mm.mysql.Driver
torque.dsfactory.bookstore.datasource.url =\
  jdbc:mysql://localhost:3306/bookstore
</pre></div>
  

  </div></div></div><div class="clear"><hr></hr></div><div id="footer"><div class="xright">© 2000-2008, Apache Software Foundation</div><div class="clear"><hr></hr></div></div></body></html>